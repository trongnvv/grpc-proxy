# http {
#     log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                       '$status $body_bytes_sent "$http_referer" '
#                       '"$http_user_agent"';
#     upstream grpcservers {
#         server 192.168.135.133:8001;
#         server 192.168.135.133:8002;
#     }
#
#     server {
#         listen 8000 http2;
#
#         location /proto.TestService {
#             grpc_pass grpc://grpcservers;
#             error_page 502 = /error502grpc;
#         }
#
#         location = /error502grpc {
#             internal;
#             default_type application/grpc;
#             add_header grpc-status 14;
#             add_header grpc-message "unavailable";
#             return 204;
#         }
#     }
# }
events {
    worker_connections 1024;
}
http {

#     log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                       '$status $body_bytes_sent "$http_referer" '
#                       '"$http_user_agent"';
#     access_log logs/access.log main;
     upstream grpcservers {
        server 192.168.135.133:8001;
        server 192.168.135.133:8002;
    }
    server {
        listen 8000 http2;
        location / {
            # Replace localhost:50051 with the address and port of your gRPC server
            # The 'grpc://' prefix is optional; unencrypted gRPC is the default
            grpc_pass grpc://192.168.135.133:8002;
#             grpc_pass grpc://grpcservers;
            error_page 502 = /error502grpc;
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($request_method = 'POST') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web';
                add_header 'Access-Control-Expose-Headers' 'Content-Transfer-Encoding';
            }
        }

        location = /error502grpc {
                internal;
                default_type application/grpc;
                add_header grpc-status 14;
                add_header grpc-message "unavailable";
                return 204;
        }

    }
}